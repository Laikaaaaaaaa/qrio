<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard - Qrio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Be Vietnam Pro', system-ui, sans-serif;
            background: #0f0f1a;
            color: #e4e4e7;
            min-height: 100vh;
        }

        /* Background like public pages */
        .bg-effects {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(56px);
            opacity: 0.22;
            will-change: transform;
            animation: floatOrb 28s ease-in-out infinite;
        }

        .bg-orb-1 {
            width: 420px;
            height: 420px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            top: -160px;
            right: -140px;
            animation-delay: 0s;
        }

        .bg-orb-2 {
            width: 320px;
            height: 320px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            bottom: 80px;
            left: -140px;
            animation-delay: -6s;
        }

        .bg-orb-3 {
            width: 260px;
            height: 260px;
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            top: 44%;
            right: 18%;
            animation-delay: -12s;
        }

        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.05); }
            50% { transform: translate(-20px, 20px) scale(0.95); }
            75% { transform: translate(-30px, -20px) scale(1.02); }
        }

        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(124, 58, 237, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(124, 58, 237, 0.03) 1px, transparent 1px);
            background-size: 56px 56px;
            pointer-events: none;
            z-index: 0;
            animation: gridDrift 30s linear infinite;
        }

        @keyframes gridDrift {
            from { background-position: 0 0; }
            to { background-position: 240px 240px; }
        }
        
        /* ========================
           HEADER
           ======================== */
        .header {
            background: rgba(24, 24, 27, 0.85);
            border-bottom: 1px solid rgba(124, 58, 237, 0.12);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            gap: 0.75rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header h1 i {
            margin-right: 0.6rem;
            color: #c7d2fe;
        }
        
        .badge {
            background: #22c55e20;
            color: #22c55e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.85rem 1rem;
            }

            .header-left {
                width: 100%;
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 0.5rem;
            }

            .session-info {
                font-size: 0.65rem;
                gap: 0.35rem;
            }

            .logout-btn {
                padding: 0.4rem 0.85rem;
            }
        }

          /* ========================
              LANGUAGE PICKER
              Modal picker
              ======================== */
        .lang-picker {
            position: relative;
            user-select: none;
        }

        .lang-current {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            color: rgba(226,232,240,0.95);
            transition: all 0.3s ease;
        }

        .lang-current:hover {
            background: rgba(255,255,255,0.10);
            border-color: rgba(124, 58, 237, 0.40);
            transform: translateY(-1px);
        }

        .lang-current i {
            font-size: 14px;
            color: #a5b4fc;
            transition: transform 0.3s ease;
        }

        .lang-current:hover i {
            transform: rotate(15deg);
            color: #c4b5fd;
        }

        .lang-label {
            font-size: 13px;
            font-weight: 700;
            line-height: 1;
        }

        .lang-current:focus-visible {
            outline: none;
            border-color: rgba(124, 58, 237, 0.70);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.20);
        }

        @media (max-width: 768px) {
            .lang-label { display: none; }
            .lang-current {
                width: 40px;
                height: 40px;
                padding: 0;
                border-radius: 12px;
                justify-content: center;
                gap: 0;
            }
        }

        .lang-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.62);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 5000;
        }

        .lang-modal-overlay.show {
            display: flex;
        }

        .lang-modal {
            width: 100%;
            max-width: 380px;
            background: rgba(24, 24, 27, 0.92);
            border: 1px solid rgba(124, 58, 237, 0.22);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 30px 90px rgba(0,0,0,0.55);
            backdrop-filter: blur(12px);
        }

        .lang-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 14px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.12);
        }

        .lang-modal-title {
            font-weight: 900;
            color: #fff;
        }

        .lang-modal-close {
            border: 1px solid #3f3f46;
            background: rgba(39, 39, 42, 0.85);
            color: #e4e4e7;
            border-radius: 12px;
            padding: 8px 10px;
            cursor: pointer;
        }

        .lang-modal-close:hover {
            background: #3f3f46;
            border-color: #52525b;
        }

        .lang-modal-body {
            padding: 10px;
            display: grid;
            gap: 10px;
        }

        .lang-modal-item {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 12px;
            border-radius: 14px;
            border: 1px solid rgba(124, 58, 237, 0.16);
            background: rgba(39, 39, 42, 0.65);
            color: #e4e4e7;
            cursor: pointer;
            font-weight: 900;
            text-align: left;
        }

        .lang-modal-item:hover {
            border-color: rgba(124, 58, 237, 0.45);
            background: rgba(39, 39, 42, 0.85);
        }

        
        .session-info {
            font-size: 0.75rem;
            color: #71717a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .session-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #e4e4e7;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .logout-btn i {
            margin-right: 0.5rem;
        }
        
        .logout-btn:hover {
            background: #3f3f46;
            border-color: #52525b;
        }
        
        /* ========================
           MAIN CONTENT
           ======================== */
        .main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }
        
        /* ========================
           STATS GRID
           ======================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(24, 24, 27, 0.82);
            border: 1px solid rgba(124, 58, 237, 0.12);
            border-radius: 12px;
            padding: 1.25rem;
            transition: border-color 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .stat-card:hover {
            border-color: #3f3f46;
        }
        
        .stat-card .icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-card .icon i {
            font-size: 1.1rem;
        }
        
        .stat-card .icon.purple { background: #6366f120; }
        .stat-card .icon.blue { background: #3b82f620; }
        .stat-card .icon.green { background: #22c55e20; }
        .stat-card .icon.orange { background: #f9731620; }
        
        .stat-card h3 {
            font-size: 0.75rem;
            font-weight: 500;
            color: #71717a;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }
        
        .stat-card .change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .stat-card .change.positive { color: #22c55e; }
        .stat-card .change.negative { color: #ef4444; }
        
        /* ========================
           CHARTS GRID
           ======================== */
        .charts-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .charts-grid-secondary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .hours-control {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.8rem;
            color: #a1a1aa;
        }

        .hours-control span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .tz-buttons {
            display: inline-flex;
            gap: 0.4rem;
            background: rgba(39, 39, 42, 0.65);
            border: 1px solid rgba(124, 58, 237, 0.12);
            border-radius: 999px;
            padding: 0.2rem;
        }

        .tz-btn {
            border: 0;
            background: transparent;
            color: #e4e4e7;
            padding: 0.2rem 0.8rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.78rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .tz-btn.active {
            background: rgba(99, 102, 241, 0.18);
            color: #c7d2fe;
        }
        
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: rgba(24, 24, 27, 0.82);
            border: 1px solid rgba(124, 58, 237, 0.12);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 86px;
            right: 18px;
            max-width: 360px;
            z-index: 200;
            opacity: 0;
            transform: translateY(-8px);
            pointer-events: none;
            transition: opacity 0.18s ease, transform 0.18s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-inner {
            background: rgba(24, 24, 27, 0.92);
            border: 1px solid rgba(124, 58, 237, 0.18);
            border-left: 4px solid rgba(124, 58, 237, 0.8);
            color: #e4e4e7;
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: 0 18px 44px rgba(0,0,0,0.45);
            display: flex;
            gap: 10px;
            align-items: flex-start;
            backdrop-filter: blur(10px);
        }

        .toast-inner i {
            margin-top: 2px;
            color: #a78bfa;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.86rem;
            margin-bottom: 2px;
        }

        .toast-msg {
            font-size: 0.82rem;
            color: #a1a1aa;
            line-height: 1.35;
        }
        
        .chart-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #e4e4e7;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-card h3 .emoji {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #27272a;
            border: 1px solid #3f3f46;
        }

        .chart-card h3 .emoji i {
            font-size: 0.9rem;
            color: #c7d2fe;
        }
        
        /* ========================
           LINE CHART
           ======================== */
        .line-chart-container {
            height: 250px;
            position: relative;
        }
        
        .line-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 220px;
            padding: 0 0.5rem;
            border-bottom: 1px solid #27272a;
        }
        
        .line-bar {
            flex: 1;
            margin: 0 4px;
            background: linear-gradient(180deg, #6366f1, #4f46e5);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .line-bar:hover {
            background: linear-gradient(180deg, #818cf8, #6366f1);
            transform: scaleY(1.02);
        }
        
        .line-bar::before {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
            background: #27272a;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .line-bar:hover::before {
            opacity: 1;
        }
        
        .chart-labels {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0.5rem 0;
        }
        
        .chart-labels span {
            flex: 1;
            text-align: center;
            font-size: 0.7rem;
            color: #71717a;
        }
        
          /* ========================
              BAR CHART
              ======================== */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .bar-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .bar-rank {
            width: 20px;
            font-size: 0.75rem;
            color: #52525b;
            font-weight: 600;
        }
        
        .bar-label {
            width: 110px;
            font-size: 0.8rem;
            color: #a1a1aa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .bar-track {
            flex: 1;
            height: 20px;
            background: #27272a;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .bar-value {
            width: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #e4e4e7;
            text-align: right;
        }
        
        /* ========================
           EVENTS LIST
           ======================== */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .event-card {
            background: #27272a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .event-card:hover {
            background: #3f3f46;
        }
        
        .event-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .event-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .event-icon.view { background: #3b82f620; }
        .event-icon.generate { background: #22c55e20; }
        .event-icon.download { background: #f9731620; }
        
        .event-name {
            font-size: 0.875rem;
            color: #e4e4e7;
            font-weight: 500;
        }
        
        .event-count {
            font-size: 1.25rem;
            font-weight: 700;
            color: #6366f1;
        }
        
        /* ========================
           LOADING & ERROR STATES
           ======================== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #71717a;
            font-size: 0.875rem;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #3f3f46;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #52525b;
        }
        
        .empty-state .emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .empty-state .emoji i {
            font-size: 1em;
            color: #71717a;
        }
        
        /* ========================
           FOOTER
           ======================== */
        .footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.75rem;
            color: #52525b;
            border-top: 1px solid #18181b;
            margin-top: 2rem;
        }
        
        .footer a {
            color: #6366f1;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* ========================
           RESPONSIVE
           ======================== */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .main {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card .value {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .bar-label {
                width: 60px;
            }
        }

        /* ========================
           TABS
           ======================== */
        .tabs {
            max-width: 1400px;
            margin: 0 auto;
            padding: 14px 2rem 0;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .tabs {
                padding: 12px 1rem 0;
            }
        }

        .tabbar {
            display: inline-flex;
            gap: 8px;
            padding: 6px;
            border-radius: 12px;
            background: rgba(24, 24, 27, 0.72);
            border: 1px solid rgba(124, 58, 237, 0.12);
            backdrop-filter: blur(10px);
        }

        .tabbtn {
            border: 0;
            background: transparent;
            color: #a1a1aa;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tabbtn.active {
            background: rgba(99, 102, 241, 0.18);
            color: #e4e4e7;
            border: 1px solid rgba(99, 102, 241, 0.25);
        }

        .messages-list {
            display: grid;
            gap: 12px;
        }

        .msg-card {
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .msg-card:hover {
            background: #3f3f46;
            border-color: #52525b;
        }

        .msg-head {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .msg-title {
            font-weight: 800;
            color: #e4e4e7;
            font-size: 0.95rem;
            line-height: 1.2;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .msg-time {
            font-size: 0.75rem;
            color: #71717a;
            white-space: nowrap;
        }

        .msg-meta {
            font-size: 0.8rem;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .msg-body {
            white-space: pre-wrap;
            word-break: break-word;
            color: #e4e4e7;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .msg-body-preview {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            color: #d4d4d8;
        }

        /* ========================
           MESSAGE MODAL
           ======================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 400;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            width: min(860px, 100%);
            max-height: min(80vh, 720px);
            overflow: hidden;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid rgba(124, 58, 237, 0.22);
            border-radius: 16px;
            box-shadow: 0 22px 60px rgba(0,0,0,0.55);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.9), rgba(124, 58, 237, 0.85), rgba(236, 72, 153, 0.75));
            pointer-events: none;
        }

        .modal-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.12);
            background: rgba(24, 24, 27, 0.55);
            backdrop-filter: blur(10px);
        }

        .modal-title {
            font-weight: 900;
            font-size: 1rem;
            color: #e4e4e7;
            line-height: 1.25;
            min-width: 0;
            word-break: break-word;
        }

        .modal-sub {
            margin-top: 6px;
            font-size: 0.82rem;
            color: #a1a1aa;
            line-height: 1.4;
            word-break: break-word;
        }

        .modal-close {
            border: 1px solid #3f3f46;
            background: rgba(39, 39, 42, 0.85);
            color: #e4e4e7;
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            flex: 0 0 auto;
        }

        .modal-close:hover {
            background: #3f3f46;
            border-color: #52525b;
        }

        .modal-body {
            padding: 14px 16px;
            overflow: auto;
        }

        .modal-message {
            white-space: pre-wrap;
            word-break: break-word;
            color: #e4e4e7;
            font-size: 0.95rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="bg-effects" aria-hidden="true">
        <div class="bg-orb bg-orb-1"></div>
        <div class="bg-orb bg-orb-2"></div>
        <div class="bg-orb bg-orb-3"></div>
    </div>
    <div class="bg-grid" aria-hidden="true"></div>
    <header class="header">
        <div class="header-left">
            <h1><i class="fa-solid fa-chart-simple" aria-hidden="true"></i><span data-i18n="title">Admin Dashboard</span></h1>
            <span class="badge" data-i18n="badge_readonly">READ-ONLY</span>
        </div>
        <div class="header-actions">
            <div class="lang-picker" id="langPicker" title="Language">
                <div class="lang-current" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                    <i class="fa-solid fa-globe" aria-hidden="true"></i>
                    <span id="langLabel" class="lang-label">English</span>
                </div>
            </div>
            <div class="session-info">
                <span class="session-dot"></span>
                <span data-i18n="session_30m">Phiên: 30 phút</span>
            </div>
            <form method="POST" action="/admin/logout" style="margin:0">
                <button type="submit" class="logout-btn"><i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i><span data-i18n="logout">Đăng xuất</span></button>
            </form>
        </div>
    </header>

    <div class="tabs">
        <div class="tabbar" role="tablist" aria-label="Admin tabs">
            <button class="tabbtn active" id="tab-analytics" type="button" role="tab" aria-selected="true">
                <i class="fa-solid fa-chart-line" aria-hidden="true"></i> <span data-i18n="tab_analytics">Analytics</span>
            </button>
            <button class="tabbtn" id="tab-messages" type="button" role="tab" aria-selected="false">
                <i class="fa-solid fa-inbox" aria-hidden="true"></i> <span data-i18n="tab_messages">Tin nhắn</span>
            </button>
        </div>
    </div>

    <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
        <div class="toast-inner">
            <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
            <div>
                <div class="toast-title" data-i18n="toast_title">Thông báo</div>
                <div class="toast-msg" id="toast-msg">...</div>
            </div>
        </div>
    </div>

    <div class="lang-modal-overlay" id="langModalOverlay" aria-hidden="true">
        <div class="lang-modal" role="dialog" aria-modal="true" aria-label="Language">
            <div class="lang-modal-header">
                <div class="lang-modal-title" data-i18n="lang_choose">Chọn ngôn ngữ</div>
                <button type="button" class="lang-modal-close" id="langModalClose" aria-label="Close">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>
            <div class="lang-modal-body">
                <button type="button" class="lang-modal-item" data-lang="vi">Tiếng Việt <i class="fa-solid fa-check" aria-hidden="true" style="opacity:.0" data-lang-check="vi"></i></button>
                <button type="button" class="lang-modal-item" data-lang="en">English <i class="fa-solid fa-check" aria-hidden="true" style="opacity:.0" data-lang-check="en"></i></button>
            </div>
        </div>
    </div>
    
    <main class="main">
        <section id="view-analytics">
        <!-- Stats Cards -->
        <div class="section-title" data-i18n="overview">Tổng quan</div>
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="icon purple" aria-hidden="true"><i class="fa-solid fa-eye"></i></div>
                <h3 data-i18n="total_views">Tổng lượt xem</h3>
                <div class="value" id="total-views">--</div>
            </div>
            <div class="stat-card">
                <div class="icon blue" aria-hidden="true"><i class="fa-solid fa-calendar-day"></i></div>
                <h3 data-i18n="today">Hôm nay</h3>
                <div class="value" id="today-views">--</div>
            </div>
            <div class="stat-card">
                <div class="icon green" aria-hidden="true"><i class="fa-solid fa-bolt"></i></div>
                <h3 data-i18n="qr_generated">QR đã tạo</h3>
                <div class="value" id="total-generated">--</div>
            </div>
            <div class="stat-card">
                <div class="icon orange" aria-hidden="true"><i class="fa-solid fa-download"></i></div>
                <h3 data-i18n="downloads">Lượt tải xuống</h3>
                <div class="value" id="total-downloads">--</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-chart-line"></i></span> <span data-i18n="views_7d">Lượt xem 7 ngày qua</span></h3>
                <div class="line-chart-container">
                    <div class="line-chart" id="daily-chart">
                        <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                    </div>
                    <div class="chart-labels" id="daily-labels"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-mobile-screen"></i></span> <span data-i18n="top_devices">Top thiết bị sử dụng</span></h3>
                <div id="devices-chart" class="bar-chart">
                    <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                </div>
            </div>
        </div>

        <div class="charts-grid-secondary">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-clock"></i></span> <span data-i18n="top_hours">Top khung giờ hoạt động</span></h3>
                    <div class="hours-control">
                        <span data-i18n="hours_timezone">Giờ hiển thị:</span>
                        <div class="tz-buttons" role="group" aria-label="Timezone selector">
                            <button type="button" class="tz-btn active" data-tz="utc"><span data-i18n="tz_utc">UTC</span></button>
                            <button type="button" class="tz-btn" data-tz="vn"><span data-i18n="tz_vn">VN (UTC+7)</span></button>
                        </div>
                    </div>
                </div>
                <div id="hours-chart" class="bar-chart">
                    <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                </div>
            </div>

            <div class="chart-card">
                <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-qrcode"></i></span> <span data-i18n="top_qr_types">Top loại mã QR được tạo</span></h3>
                <div id="qrtypes-chart" class="bar-chart">
                    <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                </div>
            </div>

            <div class="chart-card">
                <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-share-nodes"></i></span> <span data-i18n="top_sources">Top nguồn truy cập</span></h3>
                <div id="sources-chart" class="bar-chart">
                    <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                </div>
            </div>
        </div>
        
        <!-- Events -->
        <div class="chart-card">
            <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-bullseye"></i></span> <span data-i18n="events">Sự kiện</span></h3>
            <div id="events-list" class="events-grid">
                <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
            </div>
        </div>
        </section>

        <section id="view-messages" style="display:none">
            <div class="section-title" data-i18n="messages">Tin nhắn</div>
            <div class="chart-card">
                <h3><span class="emoji" aria-hidden="true"><i class="fa-solid fa-inbox"></i></span> <span data-i18n="messages_from_contact">Tin nhắn từ trang liên hệ</span></h3>
                <div id="messages-list" class="messages-list">
                    <div class="loading"><span class="spinner"></span> <span data-i18n="loading">Đang tải...</span></div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="footer">
        <p><span data-i18n="footer_prefix">Qrio Admin Dashboard • Dữ liệu được tải từ server •</span> <a href="/" data-i18n="footer_home">← Về trang chủ</a></p>
    </footer>

    <div class="modal-overlay" id="msg-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="msg-modal-title" style="display:none">
        <div class="modal" role="document">
            <div class="modal-head">
                <div style="min-width:0">
                    <div class="modal-title" id="msg-modal-title">(Không có chủ đề)</div>
                    <div class="modal-sub" id="msg-modal-meta">...</div>
                </div>
                <button type="button" class="modal-close" id="msg-modal-close" aria-label="Đóng">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-message" id="msg-modal-message"></div>
            </div>
        </div>
    </div>
    
    <script>
        /**
         * ========================
         * ADMIN DASHBOARD JS
         * ========================
         * SECURITY NOTES:
         * - NO localStorage
         * - NO sessionStorage  
         * - NO tokens in JS
         * - All auth via HttpOnly cookies
         * - All data sanitized before render
         */
        (function() {
            'use strict';

            var toastEl = document.getElementById('toast');
            var toastMsgEl = document.getElementById('toast-msg');
            var toastTimer = null;

            // Language (no localStorage): read from ?lang=vi|en or browser default
            var LANG_TEXT = {
                vi: {
                    title: 'Admin Dashboard',
                    badge_readonly: 'READ-ONLY',
                    session_30m: 'Phiên: 30 phút',
                    logout: 'Đăng xuất',
                    tab_analytics: 'Analytics',
                    tab_messages: 'Tin nhắn',
                    toast_title: 'Thông báo',
                    overview: 'Tổng quan',
                    total_views: 'Tổng lượt xem',
                    today: 'Hôm nay',
                    qr_generated: 'QR đã tạo',
                    downloads: 'Lượt tải xuống',
                    views_7d: 'Lượt xem 7 ngày qua',
                    top_devices: 'Top thiết bị sử dụng',
                    top_hours: 'Top khung giờ hoạt động',
                    top_qr_types: 'Top loại mã QR được tạo',
                    top_sources: 'Top nguồn truy cập',
                    events: 'Sự kiện',
                    messages: 'Tin nhắn',
                    messages_from_contact: 'Tin nhắn từ trang liên hệ',
                    loading: 'Đang tải...',
                    footer_prefix: 'Qrio Admin Dashboard • Dữ liệu được tải từ server •',
                    footer_home: '← Về trang chủ',
                    unknown: 'Không xác định',
                    page: 'Trang',
                    source: 'Nguồn',
                    device: 'Thiết bị',
                    hours_timezone: 'Giờ hiển thị:',
                    tz_utc: 'UTC',
                    tz_vn: 'VN (UTC+7)',
                    lang_choose: 'Chọn ngôn ngữ',
                    toast_failed: 'Có lỗi xảy ra.',
                    toast_failed_summary: 'Không thể tải tổng quan.',
                    toast_failed_devices: 'Không thể tải thống kê thiết bị.',
                    toast_failed_hours: 'Không thể tải thống kê khung giờ.',
                    toast_failed_qrtypes: 'Không thể tải thống kê loại QR.',
                    toast_failed_sources: 'Không thể tải thống kê nguồn truy cập.',
                    toast_failed_events: 'Không thể tải sự kiện.',
                    toast_failed_messages: 'Không thể tải tin nhắn.',
                    empty_no_data: 'Chưa có dữ liệu',
                    empty_cant_load: 'Không thể tải dữ liệu',
                    empty_no_messages: 'Chưa có tin nhắn',
                    empty_no_events: 'Chưa có sự kiện nào'
                },
                en: {
                    title: 'Admin Dashboard',
                    badge_readonly: 'READ-ONLY',
                    session_30m: 'Session: 30 minutes',
                    logout: 'Log out',
                    tab_analytics: 'Analytics',
                    tab_messages: 'Messages',
                    toast_title: 'Notice',
                    overview: 'Overview',
                    total_views: 'Total views',
                    today: 'Today',
                    qr_generated: 'QR generated',
                    downloads: 'Downloads',
                    views_7d: 'Views (last 7 days)',
                    top_devices: 'Top devices',
                    top_hours: 'Top active hours',
                    top_qr_types: 'Top QR types',
                    top_sources: 'Top traffic sources',
                    events: 'Events',
                    messages: 'Messages',
                    messages_from_contact: 'Messages from contact page',
                    loading: 'Loading...',
                    footer_prefix: 'Qrio Admin Dashboard • Data loaded from server •',
                    footer_home: '← Back to home',
                    unknown: 'Unknown',
                    page: 'Page',
                    source: 'Source',
                    device: 'Device',
                    hours_timezone: 'Display timezone:',
                    tz_utc: 'UTC',
                    tz_vn: 'VN (UTC+7)',
                    lang_choose: 'Choose language',
                    toast_failed: 'Something went wrong.',
                    toast_failed_summary: 'Failed to load overview.',
                    toast_failed_devices: 'Failed to load device stats.',
                    toast_failed_hours: 'Failed to load hour stats.',
                    toast_failed_qrtypes: 'Failed to load QR type stats.',
                    toast_failed_sources: 'Failed to load source stats.',
                    toast_failed_events: 'Failed to load events.',
                    toast_failed_messages: 'Failed to load messages.',
                    empty_no_data: 'No data yet',
                    empty_cant_load: 'Unable to load data',
                    empty_no_messages: 'No messages yet',
                    empty_no_events: 'No events yet'
                }
            };

            function getLang() {
                try {
                    var params = new URLSearchParams(window.location.search || '');
                    var q = (params.get('lang') || '').toLowerCase();
                    if (q === 'vi' || q === 'en') return q;
                } catch (e) {}
                try {
                    var nav = (navigator.language || '').toLowerCase();
                    if (nav.indexOf('vi') === 0) return 'vi';
                } catch (e2) {}
                return 'en';
            }

            var currentLang = getLang();

            function t(key) {
                var dict = LANG_TEXT[currentLang] || LANG_TEXT.vi;
                return (dict && dict[key]) ? dict[key] : (LANG_TEXT.vi[key] || key);
            }

            function applyLang() {
                document.documentElement.setAttribute('lang', currentLang);
                var els = document.querySelectorAll('[data-i18n]');
                for (var i = 0; i < els.length; i++) {
                    var k = els[i].getAttribute('data-i18n');
                    if (!k) continue;
                    els[i].textContent = t(k);
                }
            }

            function setLangInUrlAndReload(lang) {
                try {
                    var params = new URLSearchParams(window.location.search || '');
                    params.set('lang', (lang === 'en' ? 'en' : 'vi'));
                    window.location.href = window.location.pathname + '?' + params.toString();
                } catch (e) {
                    window.location.reload();
                }
            }

            // Message modal
            var msgModalOverlay = document.getElementById('msg-modal-overlay');
            var msgModalTitle = document.getElementById('msg-modal-title');
            var msgModalMeta = document.getElementById('msg-modal-meta');
            var msgModalMessage = document.getElementById('msg-modal-message');
            var msgModalClose = document.getElementById('msg-modal-close');
            var messagesCache = [];

            function setModalOpen(open) {
                if (!msgModalOverlay) return;
                if (open) {
                    msgModalOverlay.classList.add('show');
                    msgModalOverlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    msgModalOverlay.classList.remove('show');
                    msgModalOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            function openMessageModal(m) {
                if (!msgModalOverlay) return;
                var subject = String((m && m.subject) || '').trim() || '(Không có chủ đề)';
                var name = String((m && m.name) || '').trim();
                var email = String((m && m.email) || '').trim();
                var timeStr = String((m && m.time) || '').trim();
                var page = String((m && m.page) || '').trim();
                var source = String((m && m.source) || '').trim();
                var device = String((m && m.device) || '').trim();
                var message = String((m && m.message) || '').trim();

                if (msgModalTitle) msgModalTitle.textContent = subject;
                if (msgModalMeta) {
                    var metaBits = [];
                    var who = [name, email].filter(Boolean).join(' • ');
                    if (who) metaBits.push(who);
                    if (timeStr) metaBits.push(timeStr);
                    var extra = [page ? (t('page') + ': ' + page) : '', source ? (t('source') + ': ' + source) : '', device ? (t('device') + ': ' + device) : ''].filter(Boolean).join(' • ');
                    if (extra) metaBits.push(extra);
                    msgModalMeta.textContent = metaBits.join(' — ');
                }
                if (msgModalMessage) msgModalMessage.textContent = message;
                setModalOpen(true);
            }

            msgModalClose && msgModalClose.addEventListener('click', function() { setModalOpen(false); });
            msgModalOverlay && msgModalOverlay.addEventListener('click', function(e) {
                if (e && e.target === msgModalOverlay) setModalOpen(false);
            });
            document.addEventListener('keydown', function(e) {
                if (!msgModalOverlay) return;
                if ((e && e.key) === 'Escape' && msgModalOverlay.classList.contains('show')) {
                    setModalOpen(false);
                }
            });

            function showToast(message) {
                try {
                    toastMsgEl.textContent = String(message || t('toast_failed'));
                    toastEl.classList.add('show');
                    clearTimeout(toastTimer);
                    toastTimer = setTimeout(function() {
                        toastEl.classList.remove('show');
                    }, 3200);
                } catch (e) {
                    // ignore
                }
            }
            
            // ========================
            // SECURE FETCH
            // ========================
            function secureFetch(url) {
                return fetch(url, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(function(response) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/admin/login';
                        throw new Error('Unauthorized');
                    }
                    if (response.redirected) {
                        window.location.href = response.url;
                        throw new Error('Redirected');
                    }
                    if (!response.ok) {
                        throw new Error('Network error');
                    }
                    return response.json();
                });
            }
            
            // ========================
            // UTILITIES
            // ========================
            function formatNumber(n) {
                return (n || 0).toLocaleString('vi-VN');
            }
            
            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = String(text || '');
                return div.innerHTML;
            }

            function makePreviewText(text, maxChars) {
                var s = String(text || '');
                s = s.replace(/\s+/g, ' ').trim();
                var n = parseInt(maxChars, 10);
                if (!n || n < 40) n = 220;
                if (s.length <= n) return s;
                return s.slice(0, n).trim() + '…';
            }

            function renderBarList(containerId, data, keyName, labelFn, emptyIconClass, emptyText) {
                var container = document.getElementById(containerId);
                if (!container) return;

                if (!data || !data.length) {
                    container.innerHTML =
                        '<div class="empty-state">' +
                        '<div class="emoji"><i class="' + escapeHtml(emptyIconClass || 'fa-solid fa-inbox') + '" aria-hidden="true"></i></div>' +
                        '<div>' + escapeHtml(emptyText || t('empty_no_data')) + '</div>' +
                        '</div>';
                    return;
                }

                var maxVal = data[0].count || 1;
                var html = '';
                data.slice(0, 8).forEach(function(item, i) {
                    var pct = (item.count / maxVal) * 100;
                    var rawLabel = item[keyName];
                    var label = labelFn ? labelFn(rawLabel) : String(rawLabel || '');
                    html += '<div class="bar-item">' +
                        '<span class="bar-rank">#' + (i + 1) + '</span>' +
                        '<span class="bar-label" title="' + escapeHtml(label) + '">' + escapeHtml(label) + '</span>' +
                        '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%"></div></div>' +
                        '<span class="bar-value">' + formatNumber(item.count) + '</span>' +
                    '</div>';
                });
                container.innerHTML = html;
            }

            var hoursDataRaw = [];
            var activeHoursTimezone = 'utc';
            var hoursTzButtons = [];

            function formatHourLabelWithTimezone(raw) {
                var n = parseInt(raw, 10);
                if (isNaN(n)) return t('unknown');
                var offset = activeHoursTimezone === 'vn' ? 7 : 0;
                var display = (n + offset + 24) % 24;
                var hh = (display < 10 ? '0' : '') + display;
                var suffix = activeHoursTimezone === 'vn' ? ' (UTC+7)' : ' (UTC)';
                return hh + ':00' + suffix;
            }

            function renderHoursChart() {
                var container = document.getElementById('hours-chart');
                if (!container) return;
                if (!hoursDataRaw.length) {
                    container.innerHTML = '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-clock" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_no_data')) + '</div></div>';
                    return;
                }
                renderBarList('hours-chart', hoursDataRaw, 'hour', function(raw) {
                    return formatHourLabelWithTimezone(raw);
                }, 'fa-solid fa-clock', t('empty_no_data'));
            }

            function updateHoursTzButtons() {
                hoursTzButtons.forEach(function(btn) {
                    var tz = btn.getAttribute('data-tz');
                    btn.classList.toggle('active', tz === activeHoursTimezone);
                });
            }

            function setHoursTimezone(tz) {
                var next = (tz === 'vn' ? 'vn' : 'utc');
                if (next === activeHoursTimezone) return;
                activeHoursTimezone = next;
                updateHoursTzButtons();
                renderHoursChart();
            }

            function formatDevice(device) {
                var d = String(device || '').trim();
                if (!d || d.toLowerCase() === 'unknown') return t('unknown');
                if (d.toLowerCase() === 'mobile') return 'Mobile';
                if (d.toLowerCase() === 'desktop') return 'Desktop';
                if (d.toLowerCase() === 'tablet') return 'Tablet';
                return d;
            }

            function formatQrType(t) {
                var s = String(t || '').trim();
                if (!s || s.toLowerCase() === 'unknown') return t('unknown');
                return s;
            }

            function formatSource(s) {
                var v = String(s || '').trim().toLowerCase();
                if (!v) return 'direct';
                if (v === 'gg' || v === 'google') return 'gg';
                if (v === 'fb' || v === 'facebook') return 'fb';
                if (v === 'direct') return 'direct';
                return 'other';
            }
            
            function getEventIcon(eventName) {
                var icons = {
                    'page_view': ['fa-solid fa-eye', 'view'],
                    'generate_qr': ['fa-solid fa-bolt', 'generate'],
                    'download_qr': ['fa-solid fa-download', 'download']
                };
                return icons[eventName] || ['fa-solid fa-chart-simple', 'view'];
            }
            
            function getEventLabel(eventName) {
                var labels = currentLang === 'en' ? {
                    'page_view': 'Page views',
                    'generate_qr': 'Generate QR',
                    'download_qr': 'Download QR'
                } : {
                    'page_view': 'Lượt xem trang',
                    'generate_qr': 'Tạo mã QR',
                    'download_qr': 'Tải xuống QR'
                };
                return labels[eventName] || eventName;
            }
            
            // ========================
            // LOAD SUMMARY
            // ========================
            function loadSummary() {
                secureFetch('/analytics/summary')
                    .then(function(data) {
                        document.getElementById('total-views').textContent = formatNumber(data.total_views);
                        document.getElementById('today-views').textContent = formatNumber(data.today_views);
                        document.getElementById('total-generated').textContent = formatNumber(data.total_generated);
                        document.getElementById('total-downloads').textContent = formatNumber(data.total_downloads);
                        
                        renderDailyChart(data.daily_views || []);
                    })
                    .catch(function(err) {
                        console.error('Failed to load summary:', err.message);
                        showToast(t('toast_failed_summary'));
                        document.getElementById('daily-chart').innerHTML = 
                            '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_cant_load')) + '</div></div>';
                    });
            }
            
            // ========================
            // RENDER DAILY CHART
            // ========================
            function renderDailyChart(dailyViews) {
                var container = document.getElementById('daily-chart');
                var labels = document.getElementById('daily-labels');
                
                if (!dailyViews || !dailyViews.length) {
                    container.innerHTML = '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-inbox" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_no_data')) + '</div></div>';
                    return;
                }
                
                var maxVal = Math.max.apply(null, dailyViews.map(function(d) { return d.count; })) || 1;
                
                var barsHtml = '';
                var labelsHtml = '';
                
                dailyViews.forEach(function(d, i) {
                    var pct = Math.max(3, (d.count / maxVal) * 100);
                    var dateStr = d.date ? d.date.substring(5) : ('Day ' + (i + 1));
                    barsHtml += '<div class="line-bar" style="height:' + pct + '%" data-value="' + escapeHtml(formatNumber(d.count)) + ' lượt"></div>';
                    labelsHtml += '<span>' + escapeHtml(dateStr) + '</span>';
                });
                
                container.innerHTML = barsHtml;
                labels.innerHTML = labelsHtml;
            }
            
            function loadDevices() {
                secureFetch('/analytics/devices')
                    .then(function(data) {
                        renderBarList('devices-chart', data || [], 'device', formatDevice, 'fa-solid fa-mobile-screen', (currentLang === 'en' ? 'No device data yet' : 'Chưa có dữ liệu thiết bị'));
                    })
                    .catch(function(err) {
                        console.error('Failed to load devices:', err.message);
                        showToast(t('toast_failed_devices'));
                        renderBarList('devices-chart', [], 'device', formatDevice, 'fa-solid fa-triangle-exclamation', t('empty_cant_load'));
                    });
            }

            function loadHours() {
                secureFetch('/analytics/hours')
                    .then(function(data) {
                        hoursDataRaw = data || [];
                        renderHoursChart();
                    })
                    .catch(function(err) {
                        console.error('Failed to load hours:', err.message);
                        showToast(t('toast_failed_hours'));
                        hoursDataRaw = [];
                        renderHoursChart();
                    });
            }

            function loadQrTypes() {
                secureFetch('/analytics/qr-types')
                    .then(function(data) {
                        renderBarList('qrtypes-chart', data || [], 'qr_type', formatQrType, 'fa-solid fa-qrcode', (currentLang === 'en' ? 'No QR type data yet' : 'Chưa có dữ liệu loại QR'));
                    })
                    .catch(function(err) {
                        console.error('Failed to load qr types:', err.message);
                        showToast(t('toast_failed_qrtypes'));
                        renderBarList('qrtypes-chart', [], 'qr_type', formatQrType, 'fa-solid fa-triangle-exclamation', t('empty_cant_load'));
                    });
            }

            function loadSources() {
                secureFetch('/analytics/sources')
                    .then(function(data) {
                        renderBarList('sources-chart', data || [], 'source', formatSource, 'fa-solid fa-share-nodes', (currentLang === 'en' ? 'No source data yet' : 'Chưa có dữ liệu nguồn truy cập'));
                    })
                    .catch(function(err) {
                        console.error('Failed to load sources:', err.message);
                        showToast(t('toast_failed_sources'));
                        renderBarList('sources-chart', [], 'source', formatSource, 'fa-solid fa-triangle-exclamation', t('empty_cant_load'));
                    });
            }

            function loadMessages() {
                secureFetch('/analytics/messages?limit=80')
                    .then(function(data) {
                        var container = document.getElementById('messages-list');
                        if (!container) return;
                        if (!data || !data.length) {
                            container.innerHTML = '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-inbox" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_no_messages')) + '</div></div>';
                            return;
                        }

                        messagesCache = data;

                        var html = '';
                        data.forEach(function(m, idx) {
                            var subject = String((m && m.subject) || '').trim() || '(Không có chủ đề)';
                            var name = String((m && m.name) || '').trim();
                            var email = String((m && m.email) || '').trim();
                            var meta = [name, email].filter(Boolean).join(' • ');
                            var timeStr = String((m && m.time) || '').trim();
                            var message = String((m && m.message) || '').trim();
                            var preview = makePreviewText(message, 220);

                            html += '<div class="msg-card" data-idx="' + idx + '" role="button" tabindex="0" aria-label="Xem tin nhắn">' +
                                '<div class="msg-head">' +
                                    '<div class="msg-title" title="' + escapeHtml(subject) + '">' + escapeHtml(subject) + '</div>' +
                                    '<div class="msg-time">' + escapeHtml(timeStr) + '</div>' +
                                '</div>' +
                                (meta ? '<div class="msg-meta">' + escapeHtml(meta) + '</div>' : '') +
                                '<div class="msg-body msg-body-preview">' + escapeHtml(preview) + '</div>' +
                            '</div>';
                        });
                        container.innerHTML = html;

                        container.onclick = function(e) {
                            try {
                                var t = e && e.target;
                                if (!t) return;
                                var card = t.closest ? t.closest('.msg-card') : null;
                                if (!card) return;
                                var idxStr = card.getAttribute('data-idx');
                                var i = parseInt(idxStr, 10);
                                if (isNaN(i) || i < 0 || i >= messagesCache.length) return;
                                openMessageModal(messagesCache[i]);
                            } catch (err) {
                                // ignore
                            }
                        };

                        container.onkeydown = function(e) {
                            try {
                                var key = e && e.key;
                                if (key !== 'Enter' && key !== ' ') return;
                                var t = e.target;
                                var card = t && t.classList && t.classList.contains('msg-card') ? t : (t && t.closest ? t.closest('.msg-card') : null);
                                if (!card) return;
                                e.preventDefault();
                                var idxStr = card.getAttribute('data-idx');
                                var i = parseInt(idxStr, 10);
                                if (isNaN(i) || i < 0 || i >= messagesCache.length) return;
                                openMessageModal(messagesCache[i]);
                            } catch (err) {
                                // ignore
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error('Failed to load messages:', err.message);
                        showToast(t('toast_failed_messages'));
                        var container = document.getElementById('messages-list');
                        if (container) {
                            container.innerHTML = '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_cant_load')) + '</div></div>';
                        }
                    });
            }
            
            // ========================
            // LOAD EVENTS
            // ========================
            function loadEvents() {
                secureFetch('/analytics/events')
                    .then(function(data) {
                        var container = document.getElementById('events-list');
                        
                        if (!data || !data.length) {
                            container.innerHTML = '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-chart-simple" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_no_events')) + '</div></div>';
                            return;
                        }
                        
                        var html = '';
                        data.forEach(function(item) {
                            var iconData = getEventIcon(item.event);
                            html += '<div class="event-card">' +
                                '<div class="event-info">' +
                                    '<div class="event-icon ' + iconData[1] + '"><i class="' + escapeHtml(iconData[0]) + '" aria-hidden="true"></i></div>' +
                                    '<span class="event-name">' + escapeHtml(getEventLabel(item.event)) + '</span>' +
                                '</div>' +
                                '<span class="event-count">' + formatNumber(item.count) + '</span>' +
                            '</div>';
                        });
                        
                        container.innerHTML = html;
                    })
                    .catch(function(err) {
                        console.error('Failed to load events:', err.message);
                        showToast(t('toast_failed_events'));
                        document.getElementById('events-list').innerHTML = 
                            '<div class="empty-state"><div class="emoji"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i></div><div>' + escapeHtml(t('empty_cant_load')) + '</div></div>';
                    });
            }
            
            // ========================
            // INITIALIZE
            // ========================
            function langLabelText(lang) {
                return (lang === 'vi') ? 'Tiếng Việt' : 'English';
            }

            var langPicker = document.getElementById('langPicker');
            var langLabel = document.getElementById('langLabel');
            var langModalOverlay = document.getElementById('langModalOverlay');
            var langModalClose = document.getElementById('langModalClose');

            function setLangPickerLabel() {
                if (langLabel) langLabel.textContent = langLabelText(currentLang);
                if (!langModalOverlay) return;
                var checks = langModalOverlay.querySelectorAll('[data-lang-check]');
                for (var i = 0; i < checks.length; i++) {
                    var k = checks[i].getAttribute('data-lang-check');
                    checks[i].style.opacity = (k === currentLang) ? '1' : '0';
                }
            }

            function openLangModal() {
                if (!langModalOverlay) return;
                langModalOverlay.classList.add('show');
                langModalOverlay.setAttribute('aria-hidden', 'false');
            }

            function closeLangModal() {
                if (!langModalOverlay) return;
                langModalOverlay.classList.remove('show');
                langModalOverlay.setAttribute('aria-hidden', 'true');
            }

            if (langPicker) {
                setLangPickerLabel();

                var curBtn = langPicker.querySelector('.lang-current');
                if (curBtn) {
                    curBtn.addEventListener('click', function(e) {
                        if (e) e.stopPropagation();
                        openLangModal();
                    });
                    curBtn.addEventListener('keydown', function(e) {
                        if (!e) return;
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openLangModal();
                        }
                    });
                }
            }

            if (langModalOverlay) {
                langModalOverlay.addEventListener('click', function(e) {
                    if (e && e.target === langModalOverlay) closeLangModal();
                });
                if (langModalClose) {
                    langModalClose.addEventListener('click', function() {
                        closeLangModal();
                    });
                }

                var modalItems = langModalOverlay.querySelectorAll('[data-lang]');
                for (var m = 0; m < modalItems.length; m++) {
                    modalItems[m].addEventListener('click', function(e) {
                        if (e) e.stopPropagation();
                        var lang2 = (this.getAttribute('data-lang') || '').toLowerCase();
                        if (lang2 === 'vi' || lang2 === 'en') setLangInUrlAndReload(lang2);
                    });
                }
            }

            document.addEventListener('keydown', function(e) {
                if (!e || e.key !== 'Escape') return;
                closeLangModal();
            });

            applyLang();
            hoursTzButtons = Array.prototype.slice.call(document.querySelectorAll('.tz-btn')) || [];
            hoursTzButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var tz = btn.getAttribute('data-tz');
                    if (!tz) return;
                    setHoursTimezone(tz);
                });
            });
            updateHoursTzButtons();

            loadSummary();
            loadDevices();
            loadHours();
            loadQrTypes();
            loadSources();
            loadEvents();

            // Tabs
            var tabAnalyticsBtn = document.getElementById('tab-analytics');
            var tabMessagesBtn = document.getElementById('tab-messages');
            var viewAnalytics = document.getElementById('view-analytics');
            var viewMessages = document.getElementById('view-messages');
            var messagesLoaded = false;

            function setTab(which) {
                var isMessages = which === 'messages';
                if (tabAnalyticsBtn) {
                    tabAnalyticsBtn.classList.toggle('active', !isMessages);
                    tabAnalyticsBtn.setAttribute('aria-selected', (!isMessages).toString());
                }
                if (tabMessagesBtn) {
                    tabMessagesBtn.classList.toggle('active', isMessages);
                    tabMessagesBtn.setAttribute('aria-selected', (isMessages).toString());
                }
                if (viewAnalytics) viewAnalytics.style.display = isMessages ? 'none' : '';
                if (viewMessages) viewMessages.style.display = isMessages ? '' : 'none';

                if (isMessages && !messagesLoaded) {
                    messagesLoaded = true;
                    loadMessages();
                }
            }

            tabAnalyticsBtn && tabAnalyticsBtn.addEventListener('click', function() { setTab('analytics'); });
            tabMessagesBtn && tabMessagesBtn.addEventListener('click', function() { setTab('messages'); });
            
        })();
    </script>
</body>
</html>
